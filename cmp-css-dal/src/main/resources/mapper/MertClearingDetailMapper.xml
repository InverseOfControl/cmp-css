<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ipaylinks.cmp.css.dal.mapper.MertClearingDetailMapper">
  <resultMap id="BaseResultMap" type="com.ipaylinks.cmp.css.dal.model.MertClearingDetail">
    <!--
      @MBG Generated
      This element is automatically generated by MyBatis Generator,Do not modify ! Generated on Thu May 24 17:03:46 CST 2018.
    -->
    <id column="ID" jdbcType="VARCHAR" property="id" />
    <result column="ORDER_ID" jdbcType="VARCHAR" property="orderId" />
    <result column="MERCHANT_ID" jdbcType="VARCHAR" property="merchantId" />
    <result column="MERCHANT_NAME" jdbcType="VARCHAR" property="merchantName" />
    <result column="PAY_METHOD" jdbcType="VARCHAR" property="payMethod" />
    <result column="TRANS_TYPE" jdbcType="VARCHAR" property="transType" />
    <result column="AMOUNT_TYPE" jdbcType="VARCHAR" property="amountType" />
    <result column="TRANS_CURRENCY" jdbcType="VARCHAR" property="transCurrency" />
    <result column="TRANS_AMOUNT" jdbcType="DECIMAL" property="transAmount" />
    <result column="FEE_SETTLE_METHOD" jdbcType="VARCHAR" property="feeSettleMethod" />
    <result column="SETTLE_DATE" jdbcType="VARCHAR" property="settleDate" />
    <result column="SETTLE_CURRENCY_CODE" jdbcType="VARCHAR" property="settleCurrencyCode" />
    <result column="STATUS" jdbcType="VARCHAR" property="status" />
    <result column="GMT_CREATE_TIME" jdbcType="TIMESTAMP" property="gmtCreateTime" />
    <result column="GMT_UPDATE_TIME" jdbcType="TIMESTAMP" property="gmtUpdateTime" />
    <result column="ORDER_TYPE" jdbcType="VARCHAR" property="orderType" />
    <result column="ORI_ID" jdbcType="VARCHAR" property="oriId" />
  </resultMap>
  <sql id="Base_Column_List">
    <!--
      @MBG Generated
      This element is automatically generated by MyBatis Generator,Do not modify ! Generated on Thu May 24 17:03:46 CST 2018.
    -->
    ID, ORDER_ID, MERCHANT_ID, MERCHANT_NAME, PAY_METHOD, TRANS_TYPE, AMOUNT_TYPE, TRANS_CURRENCY,
    TRANS_AMOUNT, FEE_SETTLE_METHOD, SETTLE_DATE, SETTLE_CURRENCY_CODE, STATUS,
    GMT_CREATE_TIME, GMT_UPDATE_TIME, ORDER_TYPE, ORI_ID
  </sql>
  
  <select id="selectByPrimaryKey" parameterType="java.lang.String" resultMap="BaseResultMap">
    <!--
      @MBG Generated
      This element is automatically generated by MyBatis Generator,Do not modify ! Generated on Thu May 24 17:03:46 CST 2018.
    -->
    select 
    <include refid="Base_Column_List" />
    from T_MERT_CLEARING_DETAIL
    where ID = #{id,jdbcType=VARCHAR}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.String">
    <!--
      @MBG Generated
      This element is automatically generated by MyBatis Generator,Do not modify ! Generated on Thu May 24 17:03:46 CST 2018.
    -->
    delete from T_MERT_CLEARING_DETAIL
    where ID = #{id,jdbcType=VARCHAR}
  </delete>
  <insert id="insertSelective" parameterType="com.ipaylinks.cmp.css.dal.model.MertClearingDetail">
    <selectKey resultType="java.lang.String" keyProperty="id" order="BEFORE">
      SELECT TO_CHAR(SYSDATE, 'yymmddhh24miss')||SEQ_CYCLE_FOR_ID.nextval FROM DUAL
    </selectKey>
    insert into T_MERT_CLEARING_DETAIL
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="id != null">
        ID,
      </if>
      <if test="orderId != null">
        ORDER_ID,
      </if>
      <if test="merchantId != null">
        MERCHANT_ID,
      </if>
      <if test="merchantName != null">
        MERCHANT_NAME,
      </if>
      <if test="payMethod != null">
        PAY_METHOD,
      </if>
      <if test="transType != null">
        TRANS_TYPE,
      </if>
      <if test="amountType != null">
        AMOUNT_TYPE,
      </if>
      <if test="transCurrency != null">
        TRANS_CURRENCY,
      </if>
      <if test="transAmount != null">
        TRANS_AMOUNT,
      </if>
      <if test="feeSettleMethod != null">
        FEE_SETTLE_METHOD,
      </if>
      <if test="settleDate != null">
        SETTLE_DATE,
      </if>
      <if test="settleCurrencyCode != null">
        SETTLE_CURRENCY_CODE,
      </if>
      <if test="status != null">
        STATUS,
      </if>
      <if test="gmtCreateTime != null">
        GMT_CREATE_TIME,
      </if>
      <if test="gmtUpdateTime != null">
        GMT_UPDATE_TIME,
      </if>
      <if test="orderType != null">
        ORDER_TYPE,
      </if>
      <if test="oriId != null">
        ORI_ID,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="id != null">
        #{id,jdbcType=VARCHAR},
      </if>
      <if test="orderId != null">
        #{orderId,jdbcType=VARCHAR},
      </if>
      <if test="merchantId != null">
        #{merchantId,jdbcType=VARCHAR},
      </if>
      <if test="merchantName != null">
        #{merchantName,jdbcType=VARCHAR},
      </if>
      <if test="payMethod != null">
        #{payMethod,jdbcType=VARCHAR},
      </if>
      <if test="transType != null">
        #{transType,jdbcType=VARCHAR},
      </if>
      <if test="amountType != null">
        #{amountType,jdbcType=VARCHAR},
      </if>
      <if test="transCurrency != null">
        #{transCurrency,jdbcType=VARCHAR},
      </if>
      <if test="transAmount != null">
        #{transAmount,jdbcType=DECIMAL},
      </if>
      <if test="feeSettleMethod != null">
        #{feeSettleMethod,jdbcType=VARCHAR},
      </if>
      <if test="settleDate != null">
        #{settleDate,jdbcType=VARCHAR},
      </if>
      <if test="settleCurrencyCode != null">
        #{settleCurrencyCode,jdbcType=VARCHAR},
      </if>
      <if test="status != null">
        #{status,jdbcType=VARCHAR},
      </if>
      <if test="gmtCreateTime != null">
        #{gmtCreateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="gmtUpdateTime != null">
        #{gmtUpdateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="orderType != null">
        #{orderType,jdbcType=VARCHAR},
      </if>
      <if test="oriId != null">
        #{oriId,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.ipaylinks.cmp.css.dal.model.MertClearingDetail">
    <!--
      @MBG Generated
      This element is automatically generated by MyBatis Generator,Do not modify ! Generated on Thu May 24 17:03:46 CST 2018.
    -->
    update T_MERT_CLEARING_DETAIL
    <set>
      <if test="orderId != null">
        ORDER_ID = #{orderId,jdbcType=VARCHAR},
      </if>
      <if test="merchantId != null">
        MERCHANT_ID = #{merchantId,jdbcType=VARCHAR},
      </if>
      <if test="merchantName != null">
        MERCHANT_NAME = #{merchantName,jdbcType=VARCHAR},
      </if>
      <if test="payMethod != null">
        PAY_METHOD = #{payMethod,jdbcType=VARCHAR},
      </if>
      <if test="transType != null">
        TRANS_TYPE = #{transType,jdbcType=VARCHAR},
      </if>
      <if test="amountType != null">
        AMOUNT_TYPE = #{amountType,jdbcType=VARCHAR},
      </if>
      <if test="transCurrency != null">
        TRANS_CURRENCY = #{transCurrency,jdbcType=VARCHAR},
      </if>
      <if test="transAmount != null">
        TRANS_AMOUNT = #{transAmount,jdbcType=DECIMAL},
      </if>
      <if test="feeSettleMethod != null">
        FEE_SETTLE_METHOD = #{feeSettleMethod,jdbcType=VARCHAR},
      </if>
      <if test="settleDate != null">
        SETTLE_DATE = #{settleDate,jdbcType=VARCHAR},
      </if>
      <if test="settleCurrencyCode != null">
        SETTLE_CURRENCY_CODE = #{settleCurrencyCode,jdbcType=VARCHAR},
      </if>
      <if test="status != null">
        STATUS = #{status,jdbcType=VARCHAR},
      </if>
      GMT_UPDATE_TIME = systimestamp
    </set>
    where ID = #{id,jdbcType=VARCHAR}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.ipaylinks.cmp.css.dal.model.MertClearingDetail">
    <!--
      @MBG Generated
      This element is automatically generated by MyBatis Generator,Do not modify ! Generated on Thu May 24 17:03:46 CST 2018.
    -->
    update T_MERT_CLEARING_DETAIL
    set ORDER_ID = #{orderId,jdbcType=VARCHAR},
      MERCHANT_ID = #{merchantId,jdbcType=VARCHAR},
      MERCHANT_NAME = #{merchantName,jdbcType=VARCHAR},
      PAY_METHOD = #{payMethod,jdbcType=VARCHAR},
      TRANS_TYPE = #{transType,jdbcType=VARCHAR},
      AMOUNT_TYPE = #{amountType,jdbcType=VARCHAR},
      TRANS_CURRENCY = #{transCurrency,jdbcType=VARCHAR},
      TRANS_AMOUNT = #{transAmount,jdbcType=DECIMAL},
      FEE_SETTLE_METHOD = #{feeSettleMethod,jdbcType=VARCHAR},
      SETTLE_DATE = #{settleDate,jdbcType=VARCHAR},
      SETTLE_CURRENCY_CODE = #{settleCurrencyCode,jdbcType=VARCHAR},
      STATUS = #{status,jdbcType=VARCHAR},
      GMT_UPDATE_TIME = systimestamp
    where ID = #{id,jdbcType=VARCHAR}
  </update>
  <select id="getMertClearingDetailList" parameterType="com.ipaylinks.cmp.css.dal.model.MertClearingDetail" resultMap="BaseResultMap">
    select * from t_mert_clearing_detail t where t.trans_type = #{transType,jdbcType=VARCHAR}
  </select>

  <select id="selectList" parameterType="com.ipaylinks.cmp.css.dal.model.MertClearingDetail" resultMap="BaseResultMap">
    select
    <include refid="Base_Column_List" />
    from T_MERT_CLEARING_DETAIL
    where 1 = 1
    <if test="orderId != null and orderId != ''">
      and ORDER_ID = #{orderId}
    </if>
    <if test="merchantId != null and merchantId != ''">
      and MERCHANT_ID = #{merchantId}
    </if>
    <if test="merchantName != null and merchantName != ''">
      and MERCHANT_NAME = #{merchantName}
    </if>
    <if test="transType != null and transType != ''">
      and TRANS_TYPE = #{transType}
    </if>
    <if test="amountType != null and amountType != ''">
      and AMOUNT_TYPE = #{amountType}
    </if>
    <if test="feeSettleMethod != null and feeSettleMethod != ''">
      and FEE_SETTLE_METHOD = #{feeSettleMethod}
    </if>
    <if test="status != null and status != ''">
      and STATUS = #{status}
    </if>
    <if test="transCurrency != null and transCurrency != ''">
      and TRANS_CURRENCY = #{transCurrency}
    </if>
    <if test="settleDate != null and settleDate != ''">
      and SETTLE_DATE = #{settleDate}
    </if>
    <if test="orderType != null and orderType != ''">
      and ORDER_TYPE = #{orderType}
    </if>
    <if test="oriId != null and oriId != ''">
      and ORI_ID = #{oriId}
    </if>
    order by GMT_CREATE_TIME desc
  </select>

  <resultMap id="BaseResultMap2" extends="BaseResultMap" type="com.ipaylinks.cmp.css.dal.model.MertClearingDetail">
    <result column="RECORD_COUNT" jdbcType="DECIMAL" property="recordCount" />
    <result column="TRADE_MONTH" jdbcType="VARCHAR" property="tradeMonth" />
  </resultMap>
  <select id="sumLastMonthRecord" resultMap="BaseResultMap2">
     select t.merchant_id,
           t.pay_method,
           t.trans_type,
           t.amount_type,
           t.trans_currency,
           count(1) record_count,
           sum(t.trans_amount) trans_amount,
           to_char(trunc(add_months(sysdate, -1), 'month'), 'yyyyMM') trade_month
      from css.t_mert_clearing_detail t
      where t.gmt_create_time <![CDATA[<]]> trunc(sysdate, 'month')
      and t.gmt_create_time <![CDATA[>=]]> trunc(add_months(sysdate, -1), 'month')
     group by t.merchant_id, t.pay_method, t.trans_type, t.amount_type, t.trans_currency
  </select>

  <!-- 查询商户手续费 -->
  <resultMap id="MertFeeResultMap" type="com.ipaylinks.cmp.css.dal.model.MertFee">
    <result column="merchantId" jdbcType="VARCHAR" property="merchantId" />
    <result column="merchantName" jdbcType="VARCHAR" property="merchantName" />
    <result column="merchantOrderId" jdbcType="VARCHAR" property="merchantOrderId" />
    <result column="orderId" jdbcType="VARCHAR" property="orderId" />
    <result column="transType" jdbcType="VARCHAR" property="transType" />
    <result column="amountType" jdbcType="VARCHAR" property="amountType" />
    <result column="transCurrency" jdbcType="VARCHAR" property="transCurrency" />
    <result column="transAmount" jdbcType="DECIMAL" property="transAmount" />
    <result column="feeCurrency" jdbcType="VARCHAR" property="feeCurrency" />
    <result column="feeAmount" jdbcType="DECIMAL" property="feeAmount" />
    <result column="feeSettleCurrency" jdbcType="VARCHAR" property="feeSettleCurrency" />
    <result column="feeSettleAmount" jdbcType="DECIMAL" property="feeSettleAmount" />
    <result column="orderDate" jdbcType="VARCHAR" property="orderDate" />
    <result column="settleDate" jdbcType="VARCHAR" property="settleDate" />
    <result column="settleRate" jdbcType="VARCHAR" property="settleRate" />
    <result column="feeSettleMethod" jdbcType="VARCHAR" property="feeSettleMethod" />
    <result column="settleStatus" jdbcType="VARCHAR" property="settleStatus" />
  </resultMap>
  <select id="selectMertFee" parameterType="com.ipaylinks.cmp.css.dal.model.MertFee" resultMap="MertFeeResultMap">
    select mcd.merchant_id merchantId,
      mcd.merchant_name merchantName,
      msd.merchant_order_id merchantOrderId,
      mcd.order_id orderId,
      mcd.trans_type transType,
      mcd.amount_type amountType,
      mcd.trans_currency transCurrency,
      mcd.trans_amount transAmount,
      msd.settle_currency feeCurrency,
      msd.settle_amount feeAmount,
      msd.settle_currency feeSettleCurrency,
      msd.settle_amount feeSettleAmount,
      mcd.settle_date orderDate,
      msd.settle_date settleDate,
      msd.settle_rate settleRate,
      msd.fee_settle_method feeSettleMethod,
      msd.settle_status settleStatus,
      msd.accounting_status accountingStatus,
      msd.id
    from t_mert_clearing_detail mcd left join t_mert_settlement_detail msd on mcd.order_id = msd.order_id
    where mcd.amount_type = msd.amount_type and mcd.amount_type &lt;&gt; '01'
    <if test="merchantId != null and merchantId != ''"> and mcd.merchant_id = #{merchantId} </if>
    <if test="merchantName != null and merchantName != ''"> and mcd.merchant_name = #{merchantName} </if>
    <if test="transType != null and transType != ''"> and mcd.trans_type = #{transType} </if>
    <if test="amountType != null and amountType != ''"> and mcd.amount_type = #{amountType} </if>
    <if test="feeSettleMethod != null and feeSettleMethod != ''"> and msd.fee_settle_method = #{feeSettleMethod} </if>
    <if test="settleStatus != null and settleStatus != ''"> and msd.settle_status = #{settleStatus} </if>
    <if test="transCurrency != null and transCurrency != ''"> and mcd.trans_currency = #{transCurrency} </if>
    <if test="beginOrderDate != null and beginOrderDate != ''"> and mcd.settle_date &gt;= #{beginOrderDate} </if>
    <if test="endOrderDate != null and endOrderDate != ''"> and mcd.settle_date &lt;= #{endOrderDate} </if>
    <if test="beginSettleDate != null and beginSettleDate != ''"> and msd.settle_date &gt;= #{beginSettleDate} </if>
    <if test="endSettleDate != null and endSettleDate != ''"> and msd.settle_date &lt;= #{endSettleDate} </if>
    order by mcd.gmt_create_time desc
  </select>

  <!-- 收费 -->
  <update id="charge" parameterType="com.ipaylinks.cmp.css.dal.model.MertFee">
    update t_mert_settlement_detail set settle_status = #{settleStatus} where ID = #{id}
  </update>
  <!-- 获取原始交易订单的比例费 -->
  <select id="selectOgiProportionalFee"  parameterType="java.lang.String" resultMap="BaseResultMap2">
       select t.trans_amount
       from css.t_mert_clearing_detail t
       where t.merchant_id = #{merchantId}
         and t.order_id =#{oriOrderId}
         and t.amount_type = #{amountType}
  </select>
</mapper>
